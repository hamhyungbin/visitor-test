<style>
    .nickname-section { margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; }
    input { padding: 10px; border-radius: 5px; border: 1px solid #ddd; width: 60%; }
    button { padding: 10px 15px; background: #007AFF; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .visitor-list { text-align: left; margin-top: 20px; max-height: 200px; overflow-y: auto; font-size: 0.9rem; }
    .visitor-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dashed #eee; }
</style>

<div class="card">
    <h2>누적 방문자 수: <span id="count">--</span>명</h2>
    <h3 style="color: #007AFF;">당신은 <span id="my-order">--</span>번째 방문자입니다!</h3>
    
    <div class="nickname-section">
        <input type="text" id="nickname-input" placeholder="닉네임 입력">
        <button onclick="updateNickname()">수정</button>
    </div>

    <div id="visitor-list" class="visitor-list">
        </div>
</div>

<script type="module">
    import FingerprintJS from 'https://openfpcdn.io/fingerprintjs/v4/esm.min.js';

    let visitorFingerprint = '';

    window.updateNickname = async () => {
        const nickname = document.getElementById('nickname-input').value;
        await trackVisitor(nickname);
    };

    async function trackVisitor(name = '익명') {
        const fp = await FingerprintJS.load();
        const result = await fp.get();
        visitorFingerprint = result.visitorId;

        const response = await fetch('/api/visit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ fingerprint: visitorFingerprint, nickname: name })
        });
        const data = await response.json();

        // 화면 업데이트
        document.getElementById('count').innerText = data.totalCount;
        document.getElementById('my-order').innerText = data.myOrder;
        
        const listEl = document.getElementById('visitor-list');
        listEl.innerHTML = '<strong>방문 순서:</strong>';
        data.allVisitors.forEach((v, i) => {
            listEl.innerHTML += `<div class="visitor-item"><span>${i+1}. ${v.nickname}</span></div>`;
        });
    }

    trackVisitor(); // 초기 로드
</script>
